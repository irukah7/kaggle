# Tabular Playground Series - Apr 2022

* 4月は時系列分類の課題

数百人の参加者から記録された60秒間の生体センサーデータで、2つの活動状態のどちらかにあった可能性のある数千のシーケンスが提供されています。あなたは、センサーデータから参加者がどのような状態であったかを判断することができますか？

このコンペティションでは、60秒間のセンサーデータを分類し、被験者がその間に2つの活動状態のどちらかにあったかを示します。

#### ファイルおよびフィールドの説明
* train.csv - 約1,000人の実験参加者の13種類の生体センサーを60秒間記録した約26,000件のトレーニングセット。
* sequence - 各シーケンスの一意のID
* subject - 実験に参加した被験者の一意のID。
* step - 録画の時間ステップ、1秒間隔
* sensor_00 - sensor_12 - その時間ステップにおける 13 個のセンサーのそれぞれの値
* train_labels.csv - 各シーケンスのクラスラベル．
* sequence - 各シーケンスの一意なID．
* state - 各シーケンスに関連付けられた状態．これは、予測しようとするターゲットである。
* test.csv - テストセット．約12,000個の配列のそれぞれについて、その配列の状態の値を予測する必要がある。
* sample_submission.csv - 正しいフォーマットで作成されたサンプル投稿ファイル。

# log
# 2022/04/05
* Most Votesの記事を見る(https://www.kaggle.com/code/ambrosm/tpsapr22-eda-which-makes-sense)
* はじめに
    * train, testのサイズshapeを確認する
    * 各カラムの最大最小を確認する
* Insight
    * train被験者とtest被験者が異なるので被験者を特徴量として扱えない
    * GroupKFold cross-validationを行うことがお勧め
    * 1シーケンスあたり780個の特徴量があるので、特徴量エンジニアリングが重要な役割を果たしそう

# 2022/04/06
昨日のInsightの続き

* 被験者が学習データ中に頻繁い出現するほど、その状態(state)=1の確率が高くなる
    * 被験者を特徴量として使ってはいけないが全ての被験者に属する配列の数をカウントして、この数を特徴量として使うべき(試したら予測値が向上したらしい)
* センサーに関して
    * 13個のセンサーについて、ヒストグラムをプロットする。ヒストグラムを見ると、どのセンサーにも外れ値があることがわかる。

![](2022-04-06-19-12-59.png)

* 外れ値に対処する必要がある。外れ値がある配列が数個しかない場合は、配列全体を削除することができる。もし、ほとんどの配列が外れ値を含んでいる場合、外れ値を削除するのではなく、より妥当な値で置き換える必要がある。つまり 外れ値がシングルステップなのかシーケンス全体なのかを把握することが重要である。

* 左右の2％の外れ値を取り除いたヒストグラム

![](2022-04-06-19-12-18.png)

* 訓練データは150万行以上あるが各センサーが返すユニークな値はかなり少ない
    * センサーが離散的な値を返すか、長時間間隔で一定の値を返すことが多いらしい
    * 参考までにセンサーごとのユニークな値のカウント
    ![](2022-04-06-19-24-15.png)

## 時系列に関して

ほとんどの時系列は、周波数が高い波形をしています。「周波数が高い」というのは、ほぼサンプリングステップごとに値が正負に変化することを意味します。
振幅が重要。シーケンス1（オレンジ色）では、ほとんどの波形が時系列の前半で後半よりも振幅が大きくなっている。シーケンス0（黄色）のいくつかのセンサーでは、時系列が終了する2、3ステップ前に振幅が増加する。
センサー_02（レベルが不連続のもの）は、時々しかレベルが変化しない。
少なくとも1つのシーケンス（番号15404）は一般的なパターンに従っておらず、そのセンサーのいくつかは一定の値を持つ。
sensor_12(一番下の図)の波形は、振幅が大きく変化している。1以下（シーケンス2）から500（シーケンス8364）まで。

* 何個かシーケンスをプロットしてみる
![](2022-04-06-19-30-57.png)
* 特徴量の解析では、この振り幅の変化を何らかの方法で検出する必要がある
    * 時系列の基本周波数を測定しても、あまり意味がない
    * sensor_02 の特徴抽出は、他のセンサーとは異な。一定ではない
    * 一定値を返すセンサーをチェックする必要があり、これは機能として使えるかも


## 一定値で止める
* 全てのセンサーについて、センサーが一定値に止まっているシーケンスを数えて平均ラベルを決定する

```python
# For every sensor: count the sequences where the sensor is stuck at a constant value
def stuck_at_constant(seq):
    return seq.min() == seq.max()

for sensor in range(13):
    sensor_name = f"sensor_{sensor:02d}"
    stuck_sequences = train.groupby('sequence')[sensor_name].apply(stuck_at_constant)
    print(f"{sensor_name}: {stuck_sequences.sum():4d}   {train_labels[stuck_sequences].state.mean()}")
```

![](2022-04-06-19-43-10.png)

* この方法は、1000以上の学習シーケンスに対して正しい予測を行うことができている

## PCA
EDAでは、通常、データの主成分を分析します。しかし、今回のように外れ値が多い場合、PCAでは誤魔化しが効かない。主成分は外れ値に支配されており、外れ値除去後のPCAは全く異なるものになります。

その効果は以下の図に示されています。外れ値除去前（左）は、最初の50の主成分がほとんどすべての分散を説明しているように見えます。外れ値除去後（右）は、最初の50個の主成分はほとんど何も説明していない。

外れ値が存在する場合、PCAには注意が必要です。
相関行列も同じような問題を抱えています。もし相関が見られたら、外れ値だけが相関しているのか、それともすべてのデータが相関しているのかを確認する必要があります。
![](2022-04-06-19-47-14.png)

## 次に何をするべきか
* EDAを理解した上で基本的に2つの選択肢がある
* ニューラルネットワークを構築する
* 特徴量エンジニアリングとgradient boostingで構築する